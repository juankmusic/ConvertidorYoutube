<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JuankTube - Convertidor de YouTube</title>
    <link rel="stylesheet" href="static/style.css" />
</head>
<body>
    <div class="container">
        <h1>JuankTube</h1>
        <p>Â¡Convierte tu mÃºsica o vÃ­deo de YouTube en calidad premium, pero gratisðŸ˜Ž!</p>

        <form method="POST" action="/download" id="convert-form">
            <label for="url">URL del video:</label>
            <input type="url" id="url" name="url" placeholder="https://www.youtube.com/watch?v=..." required />

            <label for="option">Tipo de descarga:</label>
            <select id="option" name="option" required>
                <option value="video">Video (MP4, MÃ¡xima Calidad)</option>
                <option value="audio">Audio (MP3, MÃ¡xima Calidad)</option>
            </select>

            <button type="submit" id="download-btn">Descargar</button>
        </form>

        <!-- Barra de progreso -->
        <div id="progress-container" style="display:none; margin-top: 20px;">
            <div style="background:#444; border-radius: 5px; height: 25px; overflow: hidden;">
                <div id="progress-bar" style="height: 100%; width: 0%; background:#ff4444; transition: width 0.3s;"></div>
            </div>
            <p id="progress-text" style="margin-top: 8px;">Progreso: 0%</p>
        </div>

    </div>

    <footer>
        <p>&copy; 2025 Juank Music Oficial</p>
    </footer>

    <script>
    const form = document.getElementById("convert-form");
    const downloadBtn = document.getElementById("download-btn");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");

    form.addEventListener("submit", function(event) {
        event.preventDefault();

        // Deshabilitar botÃ³n para evitar doble clic
        downloadBtn.disabled = true;

        // Mostrar barra y resetear progreso
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressText.textContent = "Progreso: 0%";

        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 99) {
                progress++;
                progressBar.style.width = progress + "%";
                progressText.textContent = `Progreso: ${progress}%`;
            }
        }, 100); // Incrementa 1% cada 100ms (~10s hasta 99%)

        const formData = new FormData(form);

        fetch("/download", {
            method: "POST",
            body: formData,
        })
        .then(response => {
            if (!response.ok) throw new Error("Error en la descarga");

            return response.blob().then(blob => {
                clearInterval(interval);
                progress = 100;
                progressBar.style.width = "100%";
                progressText.textContent = "Â¡Completado!";

                // Descargar archivo
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;

                // Extraer nombre del archivo si existe en headers
                const contentDisposition = response.headers.get("Content-Disposition");
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) a.download = match[1];
                }

                a.click();
                window.URL.revokeObjectURL(url);

                // Cambiar texto del botÃ³n y habilitar para reiniciar
                downloadBtn.textContent = "Convertir otro";
                downloadBtn.disabled = false;
                downloadBtn.classList.add("convertir-otro");
            });
        })
        .catch(error => {
            clearInterval(interval);
            progressText.textContent = "Error: " + error.message;
            downloadBtn.disabled = false;
        });
    });

    downloadBtn.addEventListener("click", function(event) {
        // Si el botÃ³n estÃ¡ en modo "Convertir otro", reiniciar pÃ¡gina/formulario
        if (downloadBtn.textContent === "Convertir otro") {
            event.preventDefault();
            window.location.reload();
        }
    });
    </script>
</body>
</html>
